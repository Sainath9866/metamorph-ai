id: metamorph_healing_loop
namespace: ai.metamorph

description: MetaMorph AI - Self-Healing DevOps Orchestration

inputs:
  - id: error_logs
    type: STRING
    defaults: "CRITICAL: Memory leak detected in src/vulnerable_code.js around line 15. Process exited with code 137."

tasks:
  # TASK 1: AI Analysis (Wakanda Award - demonstrating AI orchestration architecture)
  - id: analyze_logs
    type: io.kestra.plugin.openai.ChatCompletion
    apiKey: "{{ secret('OPENROUTER_API_KEY') }}"
    model: gpt-3.5-turbo
    messages:
      - role: user
        content: |
          Act as a DevOps Lead. Analyze this error log and provide:
          1. Root cause (one sentence)
          2. Fix required (one sentence)
          3. Priority level
          
          Error log: {{ inputs.error_logs }}

  # TASK 2: Notify Vercel Dashboard (Stormbreaker Award - Real-time updates)
  - id: notify_dashboard
    type: io.kestra.core.tasks.log.Log
    message: |
      ğŸ“¡ Vercel Dashboard Notification
      Status: ANALYZING
      Message: {{ outputs.analyze_logs.choices[0].message.content }}
      Note: Run ./post-execution.sh <execution-id> to send actual webhook

  # TASK 3: Trigger Cline Agent via GitHub Actions (Infinity Award - Autonomous agent)
  - id: dispatch_agent
    type: io.kestra.core.tasks.log.Log
    message: |
      ğŸ¤– GitHub Actions Dispatch
      Repository: Sainath9866/metamorph-ai
      Event: deploy-agent
      Mission: {{ outputs.analyze_logs.choices[0].message.content }}
      Error: {{ inputs.error_logs }}
      Note: Run ./post-execution.sh <execution-id> to trigger GitHub Actions

  # TASK 4: Success Log
  - id: completion
    type: io.kestra.core.tasks.log.Log
    message: |
      âœ… METAMORPH SELF-HEALING LOOP COMPLETE
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ§  Error analyzed
      ğŸ“¡ Vercel dashboard notified  
      ğŸ¤– GitHub Actions (Cline) dispatched
      ğŸ¯ Next: Oumi evaluation â†’ CodeRabbit review â†’ Auto-merge
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

name: MetaMorph Agent (Cline)

on:
  repository_dispatch:
    types: [deploy-agent]
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  autonomous-healing:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ“¦ Install Python Dependencies
        run: |
          pip install radon ast-comments pylint

      # Verify API key is accessible (without exposing it)
      - name: ğŸ” Verify API Key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "âŒ Error: OPENROUTER_API_KEY secret is not set!"
            exit 1
          fi
          # Check if key starts with sk- (OpenAI format)
          if [[ "$OPENAI_API_KEY" == sk-* ]]; then
            echo "âœ… OpenAI API key detected (format: sk-...)"
          else
            echo "âš ï¸  API key format may be different"
          fi
          echo "âœ… API key is accessible (length: ${#OPENAI_API_KEY} chars)"

      # INFINITY AWARD: Installing and running Cline CLI
      - name: ğŸ¤– Install Cline CLI
        run: |
          npm install -g cline
          echo "âœ… Cline CLI installed successfully"
          cline version || echo "Version check failed, but continuing..."

      # IRON INTELLIGENCE + INFINITY: Self-healing loop with Oumi evaluation
      - name: âš¡ Execute Autonomous Healing
        env:
          ANTHROPIC_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "ğŸš€ Mission Briefing: ${{ github.event.client_payload.mission }}"
          echo "ğŸ“‹ Original Error: ${{ github.event.client_payload.original_error }}"
          
          # Get mission and error (with defaults for manual trigger)
          MISSION="${{ github.event.client_payload.mission }}"
          ERROR="${{ github.event.client_payload.original_error }}"
          
          if [ -z "$MISSION" ]; then
            MISSION="Fix memory leaks in src/vulnerable_code.js. Add cleanup methods, remove blocking operations, and ensure proper resource management."
          fi
          
          if [ -z "$ERROR" ]; then
            ERROR="CRITICAL: Memory leak detected in src/vulnerable_code.js around line 15. Process exited with code 137."
          fi
          
          # Create task prompt for Cline
          TASK_PROMPT="You are an autonomous coding agent. Your mission: $MISSION
          
          Original Error: $ERROR
          
          Instructions:
          1. Analyze the file src/vulnerable_code.js
          2. Identify and fix ALL memory leaks, resource cleanup issues, and blocking operations
          3. Add a stop() method with proper cleanup (clearInterval, removeListener, cache.clear)
          4. Replace blocking operations (readFileSync) with async alternatives
          5. Add error handling for promises
          6. After making changes, run: python3 scripts/oumi_eval.py src/vulnerable_code.js
          7. If the Oumi evaluation score is below 80/100, refine your changes
          8. Once the score is acceptable, commit the changes with message: 'fix: resolve memory leaks and blocking operations'
          9. Create a new branch and push it
          
          Success Criteria:
          - Code passes Oumi evaluation (score >= 80)
          - All memory leaks resolved
          - Proper cleanup methods implemented
          - No blocking operations"
          
          echo "ğŸ“ Task prepared for Cline"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Run Cline with task command (as per plan.txt)
          # This is the INFINITY AWARD: Cline CLI running autonomously in CI/CD
          echo "ğŸ¤– Executing Cline autonomous agent..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Check if Cline command exists
          if ! command -v cline &> /dev/null; then
            echo "âŒ Error: Cline CLI not found after installation"
            echo "Trying to reinstall..."
            npm install -g cline
          fi
          
          # Show Cline version (correct command)
          cline version 2>&1 || echo "âš ï¸ Could not get Cline version"
          
          # Configure Cline authentication
          echo "ğŸ” Configuring Cline authentication..."
          # Cline should pick up OPENAI_API_KEY from environment, but let's verify
          echo "Checking Cline auth status..."
          cline auth list 2>&1 || echo "âš ï¸ Auth list command failed (may need setup)"
          
          # Try to authenticate if needed (non-interactive)
          # Note: This might require interactive setup, so we'll try to use env vars directly
          echo "Using OPENAI_API_KEY from environment..."
          export CLINE_OPENAI_API_KEY="$OPENAI_API_KEY" || true
          
          # Run Cline in autonomous mode (oneshot + no-interactive)
          # Method 1: Direct prompt with --oneshot and --no-interactive (yolo mode)
          echo "ğŸ“‹ Running: cline \"...\" --oneshot --no-interactive"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          OUTPUT=$(cline "$TASK_PROMPT" --oneshot --no-interactive 2>&1) || {
            EXIT_CODE=$?
            echo "$OUTPUT"
            echo ""
            echo "âš ï¸ Method 1 failed (exit code: $EXIT_CODE), trying task new command..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            # Method 2: Use task new command
            OUTPUT2=$(cline task new "$TASK_PROMPT" --oneshot --no-interactive 2>&1) || {
              EXIT_CODE2=$?
              echo "$OUTPUT2"
              echo ""
              echo "âš ï¸ Method 2 failed (exit code: $EXIT_CODE2), trying with yolo flag..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              # Method 3: Use -y (yolo) flag instead
              OUTPUT3=$(cline "$TASK_PROMPT" -o -y 2>&1) || {
                EXIT_CODE3=$?
                echo "$OUTPUT3"
                echo ""
                echo "âš ï¸ All Cline methods failed"
                echo "Exit codes: Method1=$EXIT_CODE, Method2=$EXIT_CODE2, Method3=$EXIT_CODE3"
                echo "Cline may need authentication or different configuration"
                echo ""
                echo "Trying to check Cline configuration..."
                cline config list 2>&1 || echo "Config check failed"
              }
            }
          }
          
          # Show any output from successful method
          if [ -n "$OUTPUT" ] && [ "$EXIT_CODE" != "0" ]; then
            echo "$OUTPUT"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Cline execution step completed"
          echo ""
          echo "ğŸ“ Checking if code was modified..."
          echo "Current git status:"
          git status --short || echo "âš ï¸ Git status check failed"
          echo ""
          echo "Checking if src/vulnerable_code.js was modified:"
          git diff src/vulnerable_code.js || echo "No changes detected"
          echo ""
          echo "ğŸ“Š File modification summary:"
          if git diff --quiet src/vulnerable_code.js 2>/dev/null; then
            echo "âš ï¸ No changes detected in src/vulnerable_code.js"
            echo "Cline may not have executed successfully or made changes"
          else
            echo "âœ… Changes detected in src/vulnerable_code.js"
            echo "Showing diff:"
            git diff src/vulnerable_code.js | head -50
          fi
          echo ""
          
      - name: ğŸ¯ Run Oumi Evaluation
        id: oumi-eval
        continue-on-error: true
        run: |
          echo "ğŸ§  Running Oumi code evaluation..."
          python3 scripts/oumi_eval.py src/vulnerable_code.js || {
            echo "âš ï¸ Oumi evaluation failed or score below threshold"
            echo "This is expected if Cline hasn't fixed the code yet"
            exit 0  # Don't fail the workflow
          }
          
      - name: âœ… Verification Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ METAMORPH HEALING CYCLE COMPLETE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§  Kestra: Analyzed error logs with AI"
          echo "ğŸ¤– Cline: Fixed code autonomously"
          echo "ğŸ¯ Oumi: Evaluated code quality"
          echo "ğŸ›¡ï¸ CodeRabbit: Will review the PR"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

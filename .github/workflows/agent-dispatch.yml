name: MetaMorph Agent (Cline)

on:
  repository_dispatch:
    types: [deploy-agent]
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  autonomous-healing:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üì¶ Install Python Dependencies
        run: |
          pip install radon ast-comments pylint

      - name: üîê Verify API Key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå Error: OPENROUTER_API_KEY secret is not set!"
            exit 1
          fi
          if [[ "$OPENAI_API_KEY" == sk-* ]]; then
            echo "‚úÖ OpenAI API key detected (format: sk-...)"
          else
            echo "‚ö†Ô∏è  API key format may be different"
          fi
          echo "‚úÖ API key is accessible (length: ${#OPENAI_API_KEY} chars)"

      - name: ü§ñ Install Cline CLI
        run: |
          npm install -g cline
          echo "‚úÖ Cline CLI installed successfully"
          cline version || echo "Version check failed, but continuing..."

      - name: üîß Configure Cline for CI/CD
        env:
          ANTHROPIC_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "üîê Configuring Cline authentication..."
          
          # Configure Cline non-interactively
          cline auth --provider openrouter --apikey "$OPENAI_API_KEY" --modelid "openai/gpt-3.5-turbo" 2>&1 || {
            echo "‚ö†Ô∏è OpenRouter auth failed, trying OpenAI provider..."
            cline auth --provider openai --apikey "$OPENAI_API_KEY" --modelid "gpt-3.5-turbo" 2>&1 || {
              echo "‚ö†Ô∏è OpenAI auth also failed, but continuing..."
            }
          }
          
          echo "‚úÖ Authentication configured"
          
          # Start Cline core service in background (needed for CLI to work)
          echo "üöÄ Starting Cline core service..."
          cline instance start --detach 2>&1 || {
            echo "‚ö†Ô∏è Failed to start Cline instance, trying alternative method..."
            # Try to start without detach flag
            nohup cline instance start > /tmp/cline.log 2>&1 &
            sleep 5
            echo "‚úÖ Cline service started in background"
          }
          
          # Verify instance is running
          sleep 3
          cline instance list || echo "‚ö†Ô∏è Could not list instances"

      - name: ‚ö° Execute Autonomous Healing
        env:
          ANTHROPIC_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "üöÄ Mission Briefing: ${{ github.event.client_payload.mission }}"
          echo "üìã Original Error: ${{ github.event.client_payload.original_error }}"
          
          # Get mission and error (with defaults for manual trigger)
          MISSION="${{ github.event.client_payload.mission }}"
          ERROR="${{ github.event.client_payload.original_error }}"
          
          if [ -z "$MISSION" ]; then
            MISSION="Fix memory leaks in src/vulnerable_code.js. Add cleanup methods, remove blocking operations, and ensure proper resource management."
          fi
          
          if [ -z "$ERROR" ]; then
            ERROR="CRITICAL: Memory leak detected in src/vulnerable_code.js around line 15. Process exited with code 137."
          fi
          
          # Create task prompt for Cline
          TASK_PROMPT="You are an autonomous coding agent. Your mission: $MISSION
          
          Original Error: $ERROR
          
          Instructions:
          1. Analyze the file src/vulnerable_code.js
          2. Identify and fix ALL memory leaks, resource cleanup issues, and blocking operations
          3. Add a stop() method with proper cleanup (clearInterval, removeListener, cache.clear)
          4. Replace blocking operations (readFileSync) with async alternatives
          5. Add error handling for promises
          6. After making changes, run: python3 scripts/oumi_eval.py src/vulnerable_code.js
          7. If the Oumi evaluation score is below 80/100, refine your changes
          8. Once the score is acceptable, commit the changes with message: 'fix: resolve memory leaks and blocking operations'
          9. Create a new branch and push it
          
          Success Criteria:
          - Code passes Oumi evaluation (score >= 80)
          - All memory leaks resolved
          - Proper cleanup methods implemented
          - No blocking operations"
          
          echo "üìù Task prepared for Cline"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          echo "ü§ñ Executing Cline autonomous agent..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Starting at $(date +%H:%M:%S)..."
          
          # Save task prompt to a file
          echo "$TASK_PROMPT" > /tmp/task_prompt.txt
          
          # Method 1: Use task new with prompt from stdin and explicit non-interactive flags
          echo "üìã Attempting to create task with Cline..."
          
          # Try creating task with all non-interactive flags
          OUTPUT=$(timeout 120 cline task new \
            --no-interactive \
            --yolo \
            --oneshot \
            --mode act \
            --file src/vulnerable_code.js \
            --output-format plain \
            < /tmp/task_prompt.txt 2>&1) || {
            EXIT_CODE=$?
            echo "$OUTPUT"
            echo ""
            echo "‚ö†Ô∏è Task creation failed (exit code: $EXIT_CODE)"
            
            # Method 2: Try using the prompt as a positional argument with redirection
            echo "Trying alternative method with stdin redirection..."
            OUTPUT2=$(timeout 120 bash -c "cline --no-interactive --yolo --oneshot --mode act --file src/vulnerable_code.js --output-format plain < /tmp/task_prompt.txt" 2>&1) || {
              EXIT_CODE2=$?
              echo "$OUTPUT2"
              echo ""
              echo "‚ö†Ô∏è Alternative method failed (exit code: $EXIT_CODE2)"
              
              # Method 3: Direct prompt on command line (escape quotes)
              echo "Trying direct command line prompt..."
              ESCAPED_PROMPT=$(echo "$TASK_PROMPT" | sed 's/"/\\"/g')
              OUTPUT3=$(timeout 120 cline "$ESCAPED_PROMPT" --no-interactive --yolo --oneshot --mode act --file src/vulnerable_code.js --output-format plain 2>&1) || {
                EXIT_CODE3=$?
                echo "$OUTPUT3"
                echo ""
                echo "‚ö†Ô∏è All methods failed. Cline may require a running instance or different configuration."
                echo "Last exit code: $EXIT_CODE3"
              }
            }
          }
          
          echo ""
          echo "Completed at $(date +%H:%M:%S)"
          
          # Show any output we captured
          if [ -n "$OUTPUT" ]; then
            echo "=== OUTPUT FROM METHOD 1 ==="
            echo "$OUTPUT"
          fi
          if [ -n "$OUTPUT2" ]; then
            echo "=== OUTPUT FROM METHOD 2 ==="
            echo "$OUTPUT2"
          fi
          if [ -n "$OUTPUT3" ]; then
            echo "=== OUTPUT FROM METHOD 3 ==="
            echo "$OUTPUT3"
          fi
          
          # Check Cline logs for debugging
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìã Checking Cline logs..."
          if [ -f /tmp/cline.log ]; then
            echo "=== CLINE SERVICE LOG ==="
            tail -50 /tmp/cline.log
          fi
          
          # Check if Cline made any changes
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ Cline execution step completed"
          echo ""
          echo "üìù Checking if code was modified..."
          echo "Current git status:"
          git status --short || echo "‚ö†Ô∏è Git status check failed"
          echo ""
          echo "Checking if src/vulnerable_code.js was modified:"
          git diff src/vulnerable_code.js || echo "No changes detected"
          echo ""
          echo "üìä File modification summary:"
          if git diff --quiet src/vulnerable_code.js 2>/dev/null; then
            echo "‚ö†Ô∏è No changes detected in src/vulnerable_code.js"
            echo "Cline may not have executed successfully or made changes"
            echo ""
            echo "üí° Debugging tips:"
            echo "  - Check if Cline instance is running: cline instance list"
            echo "  - Check Cline logs: cline logs list"
            echo "  - Verify API key is working"
          else
            echo "‚úÖ Changes detected in src/vulnerable_code.js"
            echo "Showing diff:"
            git diff src/vulnerable_code.js | head -50
          fi
          echo ""
          
      - name: üéØ Run Oumi Evaluation
        id: oumi-eval
        continue-on-error: true
        run: |
          echo "üß† Running Oumi code evaluation..."
          python3 scripts/oumi_eval.py src/vulnerable_code.js || {
            echo "‚ö†Ô∏è Oumi evaluation failed or score below threshold"
            echo "This is expected if Cline hasn't fixed the code yet"
            exit 0  # Don't fail the workflow
          }
          
      - name: üßπ Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up Cline instances..."
          cline instance stop --all 2>&1 || echo "No instances to stop"
          
      - name: ‚úÖ Verification Summary
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üéâ METAMORPH HEALING CYCLE COMPLETE"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üß† Kestra: Analyzed error logs with AI"
          echo "ü§ñ Cline: Attempted autonomous code fixing"
          echo "üéØ Oumi: Evaluated code quality"
          echo "üõ°Ô∏è CodeRabbit: Will review the PR"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Final status check
          if git diff --quiet src/vulnerable_code.js 2>/dev/null; then
            echo ""
            echo "‚ö†Ô∏è  Status: No code changes were made"
            echo "    Cline may need additional configuration for CI/CD"
            echo "    Consider using Cline API directly or alternative approaches"
          else
            echo ""
            echo "‚úÖ Status: Code was modified successfully"
            echo "    Proceeding with PR creation"
          fi